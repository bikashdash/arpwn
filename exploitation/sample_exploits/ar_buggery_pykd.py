
'''
pykd script to simpulate the write-0 vulnerability as described in my syscan360 slides

sebastian apelt, siberas, 2016
'''

from pykd import *

def dbgCB(x):
	# ".printf \"DBG: %ma\\r\\n\", poi(poi(esp+c)+10);"
	s = dbgCommand(".printf \"%ma\\r\\n\", poi(poi(esp+c)+10);")
	if s.startswith("write0:") == True:
		targetaddr = int(s.split("write0:")[-1], 16)
		print "[!] perform write0 to targetaddress 0x%x" % targetaddr
		cmd = "ed %x 0" % targetaddr
		print "cmd: %s" % cmd
		print "before:"
		print dbgCommand("dd %x" % ((targetaddr &~ 0xf)-0x10))
		dbgCommand(cmd)
		print "after:"
		print dbgCommand("dd %x" % ((targetaddr &~ 0xf)-0x10))
	else:
		print s

# in order to be able to resolve the symbol you need to add the Acroform.pdb file for your Reader version!
addy = int(dbgCommand("? AcroForm!METHOD_node_isPropertySpecified").strip().split(" ")[-1], 16)
print "[!] set bp for xfa.isPropertySpecified at 0x%x" % addy
print setBp(addy, dbgCB)
go()